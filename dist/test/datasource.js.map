{"version":3,"sources":["../../src/datasource.js"],"names":["HawkularDatasource","instanceSettings","$q","backendSrv","templateSrv","type","metricsUrl","url","alertsUrl","name","tenant","jsonData","isTenantPerQuery","authorization","basicAuth","length","token","q","typeResources","variablesHelper","capabilitiesPromise","queryVersion","then","version","queryProcessor","getHeaders","bind","headers","options","validTargets","targets","filter","target","hide","map","sanitizeTarget","id","undefined","tags","tagsQL","when","data","promises","run","all","flatten","responses","sort","m1","m2","localeCompare","stats","rate","seriesAggFn","raw","timeAggFn","endpoint","datasourceRequest","method","response","status","message","title","metricIds","resolve","annotation","query","queryAlerts","start","range","from","valueOf","end","to","order","ids","allAnnotations","metrics","forEach","metric","annot","time","dp","timestamp","text","value","push","key","hasOwnProperty","replace","join","params","startTime","endTime","triggerIds","events","event","ctime","resolveForQL","result","m","tag","substr","findTags","trim","charAt","runWithResolvedVariables","p","pattern","flatTags","property","concat","func","resolved","catch"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport {VariablesHelper} from './variablesHelper';\nimport {Capabilities} from './capabilities';\nimport {QueryProcessor} from './queryProcessor';\nimport {modelToString as tagsModelToString} from './tagsKVPairsController';\n\nexport class HawkularDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.metricsUrl = instanceSettings.url + '/metrics';\n    this.alertsUrl = instanceSettings.url + '/alerts';\n    this.name = instanceSettings.name;\n    this.tenant = instanceSettings.jsonData.tenant;\n    this.isTenantPerQuery = instanceSettings.jsonData.isTenantPerQuery;\n    this.authorization = null;\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.authorization = instanceSettings.basicAuth;\n    } else if (typeof instanceSettings.jsonData.token === 'string' && instanceSettings.jsonData.token.length > 0) {\n      this.authorization = 'Bearer ' + instanceSettings.jsonData.token;\n    }\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.typeResources = {\n      'gauge': 'gauges',\n      'counter': 'counters',\n      'availability': 'availability'\n    };\n    this.variablesHelper = new VariablesHelper(templateSrv);\n    this.capabilitiesPromise = this.queryVersion().then(version => new Capabilities(version));\n    this.queryProcessor = new QueryProcessor($q, backendSrv, this.variablesHelper, this.capabilitiesPromise, this.metricsUrl,\n            this.getHeaders.bind(this), this.typeResources);\n  }\n\n  getHeaders(tenant) {\n    const headers = {\n      'Content-Type': 'application/json'\n    }\n    if (tenant && this.isTenantPerQuery) {\n      headers['Hawkular-Tenant'] = tenant;\n    } else {\n      headers['Hawkular-Tenant'] = this.tenant;\n    }\n    if (this.authorization) {\n      headers['Authorization'] = this.authorization;\n    }\n    return headers;\n  }\n\n  query(options) {\n    const validTargets = options.targets\n      .filter(target => !target.hide)\n      .map(this.sanitizeTarget)\n      .filter(target => target.id !== undefined\n         || (target.tags !== undefined && target.tags.length > 0)\n         || (target.tagsQL !== undefined && target.tagsQL.length > 0));\n\n    if (validTargets.length === 0) {\n      return this.q.when({data: []});\n    }\n\n    const promises = validTargets.map(target => this.queryProcessor.run(target, options));\n\n    return this.q.all(promises)\n      .then(responses => ({data: _.flatten(responses).sort((m1, m2) => m1.target.localeCompare(m2.target))}));\n  }\n\n  sanitizeTarget(target) {\n    // Create sane target, providing backward compatibility\n    if (target.id === undefined && target.target !== 'select metric') {\n      target.id = target.target;\n    } else if (target.id === '-- none --') {\n      delete target.id;\n    }\n    delete target.target;\n    target.stats = target.stats || [];\n    target.type = target.type || 'gauge';\n    target.rate = target.rate === true;\n    target.tags = target.tags || [];\n    target.tagsQL = target.tagsQL || '';\n    target.seriesAggFn = target.seriesAggFn || 'none';\n    if (target.raw === undefined) {\n      // Compatibility note: previously default was timeAggFn=avg and seriesAggFn=none\n      if (target.seriesAggFn === 'none' && target.timeAggFn === 'avg') {\n        delete target.timeAggFn;\n      }\n      target.raw = (target.timeAggFn === undefined);\n    }\n    return target;\n  }\n\n  testDatasource() {\n    // If tenants is unknown at this point (when having per-query tenants)\n    // We do a more basic check to / endpoint, which checks authentication in basic-auth mode but not with token/OpenShift\n    // Else, it's full connectivity with tenant check\n    const endpoint = this.isTenantPerQuery ? '/' : '/metrics';\n    return this.backendSrv.datasourceRequest({\n      url: this.metricsUrl + endpoint,\n      method: 'GET',\n      headers: this.getHeaders()\n    }).then(response => {\n      if (response.status === 200 || response.status === 204) {\n        return { status: 'success', message: 'Data source is working', title: 'Success' };\n      } else {\n        return { status: 'error', message: `Connection failed (${response.status})`, title: 'Error' };\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    const metricIds = this.variablesHelper.resolve(options.annotation.query, options);\n    if (options.annotation.type === 'alert') {\n      return this.queryAlerts(metricIds, options);\n    }\n    return this.backendSrv.datasourceRequest({\n      url: `${this.metricsUrl}/${options.annotation.type}/raw/query`,\n      data: {\n        start: options.range.from.valueOf(),\n        end: options.range.to.valueOf(),\n        order: 'ASC',\n        ids: metricIds\n      },\n      method: 'POST',\n      headers: this.getHeaders(options.annotation.tenant)\n    }).then(response => response.status == 200 ? response.data : [])\n    .then(metrics => {\n      let allAnnotations = [];\n      metrics.forEach(metric => {\n        metric.data.forEach(dp => {\n          let annot = {\n            annotation: options.annotation,\n            time: dp.timestamp,\n            title: options.annotation.name,\n            text: dp.value\n          };\n          let tags = [];\n          if (metricIds.length > 1) {\n            tags.push(metric.id);\n          }\n          if (dp.tags) {\n            for (let key in dp.tags) {\n              if (dp.tags.hasOwnProperty(key)) {\n                tags.push(dp.tags[key].replace(' ', '_'));\n              }\n            }\n          }\n          if (tags.length > 0) {\n            annot.tags = tags.join(' ');\n          }\n          allAnnotations.push(annot);\n        });\n      });\n      return allAnnotations;\n    });\n  }\n\n  queryAlerts(ids, options) {\n    return this.backendSrv.datasourceRequest({\n      url: `${this.alertsUrl}/events`,\n      params: {\n        startTime: options.range.from.valueOf(),\n        endTime: options.range.to.valueOf(),\n        triggerIds: ids\n      },\n      method: 'GET',\n      headers: this.getHeaders(options.annotation.tenant)\n    }).then(response => response.status == 200 ? response.data : [])\n    .then(events => {\n      return events.map(event => {\n        return {\n          annotation: options.annotation,\n          time: event.ctime,\n          title: options.annotation.name,\n          text: event.text,\n          tags: event.status\n        };\n      });\n    });\n  }\n\n  suggestMetrics(target) {\n    let url = this.metricsUrl + '/metrics?type=' + target.type;\n    if (target.tagsQL && target.tagsQL.length > 0) {\n      url += '&tags=' + this.variablesHelper.resolveForQL(target.tagsQL, {});\n    } else if (target.tags && target.tags.length > 0) {\n      url += '&tags=' + tagsModelToString(target.tags, this.variablesHelper, {});\n    }\n    return this.backendSrv.datasourceRequest({\n      url: url,\n      method: 'GET',\n      headers: this.getHeaders(target.tenant)\n    }).then(response => response.status == 200 ? response.data : [])\n    .then(result => {\n      return result.map(m => m.id)\n        .sort()\n        .map(id => {\n          return {text: id, value: id};\n        });\n    });\n  }\n\n  suggestTags(target, key) {\n    if (!key) {\n      return this.q.when([]);\n    }\n    return this.backendSrv.datasourceRequest({\n      url: `${this.metricsUrl}/${this.typeResources[target.type]}/tags/${key}:*`,\n      method: 'GET',\n      headers: this.getHeaders(target.tenant)\n    }).then(result => result.data.hasOwnProperty(key) ? result.data[key] : [])\n    .then(tags => tags.map(tag => {\n      return {text: tag, value: tag};\n    }));\n  }\n\n  suggestTagKeys(target) {\n    return this.backendSrv.datasourceRequest({\n      url: this.metricsUrl + '/metrics/tags',\n      method: 'GET',\n      headers: this.getHeaders(target.tenant)\n    }).then(response => response.status == 200 ? response.data : [])\n    .then(result => result.map(key => ({text: key, value: key})));\n  }\n\n  metricFindQuery(query) {\n    let params = '';\n    if (query !== undefined) {\n      if (query.substr(0, 5) === 'tags/') {\n        return this.findTags(query.substr(5).trim());\n      }\n      if (query.charAt(0) === '?') {\n        params = query;\n      } else {\n        params = '?' + query;\n      }\n    }\n    return this.runWithResolvedVariables(params, p => this.backendSrv.datasourceRequest({\n      url: `${this.metricsUrl}/metrics${p}`,\n      method: 'GET',\n      headers: this.getHeaders()\n    }).then(result => {\n      return _.map(result.data, metric => {\n        return {text: metric.id, value: metric.id};\n      });\n    }));\n  }\n\n  findTags(pattern) {\n    return this.runWithResolvedVariables(pattern, p => this.backendSrv.datasourceRequest({\n      url: `${this.metricsUrl}/metrics/tags/${p}`,\n      method: 'GET',\n      headers: this.getHeaders()\n    }).then(result => {\n      let flatTags = [];\n      if (result.data) {\n        let data = result.data;\n        for (let property in data) {\n          if (data.hasOwnProperty(property)) {\n            flatTags = flatTags.concat(data[property]);\n          }\n        }\n      }\n      return flatTags.map(tag => {\n        return {text: tag, value: tag};\n      });\n    }));\n  }\n\n  runWithResolvedVariables(target, func) {\n    const resolved = this.variablesHelper.resolve(target, {});\n    return this.q.all(resolved.map(p => func(p)))\n      .then(result => _.flatten(result));\n  }\n\n  queryVersion() {\n    return this.backendSrv.datasourceRequest({\n      url: this.metricsUrl + '/status',\n      method: 'GET',\n      headers: {'Content-Type': 'application/json'}\n    }).then(response => response.data['Implementation-Version'])\n    .catch(response => 'Unknown');\n  }\n\n  getCapabilities() {\n    return this.capabilitiesPromise;\n  }\n}\n"]}