{"version":3,"sources":["../src/datasource.js"],"names":["_","VariablesHelper","Capabilities","QueryProcessor","tagsModelToString","modelToString","HawkularDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","headers","jsonData","tenant","basicAuth","length","token","typeResources","variablesHelper","capabilitiesPromise","queryVersion","then","version","queryProcessor","options","validTargets","targets","filter","target","hide","map","sanitizeTarget","id","undefined","tags","tagsQL","when","data","promises","run","all","flatten","responses","sort","m1","m2","localeCompare","stats","rate","seriesAggFn","raw","timeAggFn","datasourceRequest","method","response","status","message","title","metricIds","resolve","annotation","query","start","range","from","valueOf","end","to","order","ids","allAnnotations","metrics","forEach","metric","annot","time","dp","timestamp","text","value","push","key","hasOwnProperty","replace","join","resolveForQL","result","m","tag","params","substr","findTags","trim","charAt","runWithResolvedVariables","p","pattern","flatTags","property","concat","func","resolved","catch"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport {VariablesHelper} from './variablesHelper';\nimport {Capabilities} from './capabilities';\nimport {QueryProcessor} from './queryProcessor';\nimport {modelToString as tagsModelToString} from './tagsKVPairsController';\n\nexport class HawkularDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.headers = {\n      'Content-Type': 'application/json',\n      'Hawkular-Tenant': instanceSettings.jsonData.tenant\n    };\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    } else if (typeof instanceSettings.jsonData.token === 'string' && instanceSettings.jsonData.token.length > 0) {\n      this.headers['Authorization'] = 'Bearer ' + instanceSettings.jsonData.token;\n    }\n    this.typeResources = {\n      \"gauge\": \"gauges\",\n      \"counter\": \"counters\",\n      \"availability\": \"availability\"\n    };\n    this.variablesHelper = new VariablesHelper(templateSrv);\n    this.capabilitiesPromise = this.queryVersion().then(version => new Capabilities(version));\n    this.queryProcessor = new QueryProcessor($q, backendSrv, this.variablesHelper, this.capabilitiesPromise, this.url, this.headers, this.typeResources);\n  }\n\n  query(options) {\n    const validTargets = options.targets\n      .filter(target => !target.hide)\n      .map(this.sanitizeTarget)\n      .filter(target => target.id !== undefined\n         || (target.tags !== undefined && target.tags.length > 0)\n         || (target.tagsQL !== undefined && target.tagsQL.length > 0));\n\n    if (validTargets.length === 0) {\n      return this.q.when({data: []});\n    }\n\n    const promises = validTargets.map(target => this.queryProcessor.run(target, options));\n\n    return this.q.all(promises)\n      .then(responses => ({data: _.flatten(responses).sort((m1, m2) => m1.target.localeCompare(m2.target))}));\n  }\n\n  sanitizeTarget(target) {\n    // Create sane target, providing backward compatibility\n    if (target.id === undefined && target.target !== 'select metric') {\n      target.id = target.target;\n    } else if (target.id === '-- none --') {\n      delete target.id;\n    }\n    delete target.target;\n    target.stats = target.stats || [];\n    target.type = target.type || 'gauge';\n    target.rate = target.rate === true;\n    target.tags = target.tags || [];\n    target.tagsQL = target.tagsQL || '';\n    target.seriesAggFn = target.seriesAggFn || 'none';\n    if (target.raw === undefined) {\n      // Compatibility note: previously default was timeAggFn=avg and seriesAggFn=none\n      if (target.seriesAggFn === 'none' && target.timeAggFn === 'avg') {\n        delete target.timeAggFn;\n      }\n      target.raw = (target.timeAggFn === undefined);\n    }\n    return target;\n  }\n\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics',\n      method: 'GET',\n      headers: this.headers\n    }).then(response => {\n      if (response.status === 200 || response.status === 204) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      } else {\n        return { status: \"error\", message: \"Connection failed (\" + response.status + \")\", title: \"Error\" };\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    const metricIds = this.variablesHelper.resolve(options.annotation.query, options);\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/strings/raw/query',\n      data: {\n        start: options.range.from.valueOf(),\n        end: options.range.to.valueOf(),\n        order: 'ASC',\n        ids: metricIds\n      },\n      method: 'POST',\n      headers: this.headers\n    }).then(response => response.status == 200 ? response.data : [])\n    .then(metrics => {\n      let allAnnotations = [];\n      metrics.forEach(metric => {\n        metric.data.forEach(dp => {\n          let annot = {\n            annotation: options.annotation,\n            time: dp.timestamp,\n            title: options.annotation.name,\n            text: dp.value\n          };\n          let tags = [];\n          if (metricIds.length > 1) {\n            tags.push(metric.id);\n          }\n          if (dp.tags) {\n            for (let key in dp.tags) {\n              if (dp.tags.hasOwnProperty(key)) {\n                tags.push(dp.tags[key].replace(' ', '_'));\n              }\n            }\n          }\n          if (tags.length > 0) {\n            annot.tags = tags.join(' ');\n          }\n          allAnnotations.push(annot);\n        });\n      });\n      return allAnnotations;\n    });\n  }\n\n  suggestQueries(target) {\n    let url = this.url + '/metrics?type=' + target.type;\n    if (target.tagsQL && target.tagsQL.length > 0) {\n      url += \"&tags=\" + this.variablesHelper.resolveForQL(target.tagsQL, {});\n    } else if (target.tags && target.tags.length > 0) {\n      url += \"&tags=\" + tagsModelToString(target.tags, this.variablesHelper, {});\n    }\n    return this.backendSrv.datasourceRequest({\n      url: url,\n      method: 'GET',\n      headers: this.headers\n    }).then(response => response.status == 200 ? response.data : [])\n    .then(result => {\n      return result.map(m => m.id)\n        .sort()\n        .map(id => {\n          return {text: id, value: id};\n        });\n    });\n  }\n\n  suggestTags(type, key) {\n    if (!key) {\n      return this.q.when([]);\n    }\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/' + this.typeResources[type] + '/tags/' + key + ':*',\n      method: 'GET',\n      headers: this.headers\n    }).then(result => result.data.hasOwnProperty(key) ? result.data[key] : [])\n    .then(tags => tags.map(tag => {\n      return {text: tag, value: tag};\n    }));\n  }\n\n  suggestTagKeys(type) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics/tags',\n      method: 'GET',\n      headers: this.headers\n    }).then(response => response.status == 200 ? response.data : [])\n    .then(result => result.map(key => ({text: key, value: key})));\n  }\n\n  metricFindQuery(query) {\n    let params = \"\";\n    if (query !== undefined) {\n      if (query.substr(0, 5) === \"tags/\") {\n        return this.findTags(query.substr(5).trim());\n      }\n      if (query.charAt(0) === '?') {\n        params = query;\n      } else {\n        params = \"?\" + query;\n      }\n    }\n    return this.runWithResolvedVariables(params, p => this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics' + p,\n      method: 'GET',\n      headers: this.headers\n    }).then(result => {\n      return _.map(result.data, metric => {\n        return {text: metric.id, value: metric.id};\n      });\n    }));\n  }\n\n  findTags(pattern) {\n    return this.runWithResolvedVariables(pattern, p => this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics/tags/' + p,\n      method: 'GET',\n      headers: this.headers\n    }).then(result => {\n      let flatTags = [];\n      if (result.data) {\n        let data = result.data;\n        for (let property in data) {\n          if (data.hasOwnProperty(property)) {\n            flatTags = flatTags.concat(data[property]);\n          }\n        }\n      }\n      return flatTags.map(tag => {\n        return {text: tag, value: tag};\n      });\n    }));\n  }\n\n  runWithResolvedVariables(target, func) {\n    const resolved = this.variablesHelper.resolve(target, {});\n    return this.q.all(resolved.map(p => func(p)))\n      .then(result => _.flatten(result));\n  }\n\n  queryVersion() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/status',\n      method: 'GET',\n      headers: {'Content-Type': 'application/json'}\n    }).then(response => response.data['Implementation-Version'])\n    .catch(response => \"Unknown\");\n  }\n\n  getCapabilities() {\n    return this.capabilitiesPromise;\n  }\n}\n"]}